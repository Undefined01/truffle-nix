/*
 * This file was generated by the Gradle 'init' task.
 */

plugins {
    id("buildlogic.java-library-conventions")
}

dependencies {
    testImplementation("io.github.tree-sitter:jtreesitter:0.24.0")
}

tasks.named("processResources") {
    dependsOn("buildNativeLibrary")
}

val osName = System.getProperty("os.name").toLowerCase()
val libExt = when {
    osName.contains("mac") -> "dylib"
    osName.contains("win") -> throw GradleException("Windows is not supported yet.")
    else -> "so"
}

tasks.register("buildNativeLibrary") {
    inputs.dir("src/main/c/tree-sitter")
    inputs.dir("src/main/c/tree-sitter-nix")
    outputs.file("src/main/resources/libtree-sitter.${libExt}")
    outputs.file("src/main/resources/libtree-sitter-nix.${libExt}")

    doLast {
        exec {
            workingDir = file("src/main/c/tree-sitter")
            commandLine("make")
        }

        val sourceFile = file("src/main/c/tree-sitter/libtree-sitter.${libExt}")
        val destinationFile = file("src/main/resources/libtree-sitter.${libExt}")

        if (sourceFile.exists()) {
            sourceFile.copyTo(destinationFile, overwrite = true)
            println("Native library copied to resources folder.")
        } else {
            throw GradleException("Native library not found after build.")
        }
    }

    doLast {
        exec {
            workingDir = file("src/main/c/tree-sitter-nix")
            commandLine("gcc", "-shared", "-fPIC", "-o", "libtree-sitter-nix.${libExt}", "src/parser.c", "src/scanner.c", "-I", "src")
        }

        val sourceFile = file("src/main/c/tree-sitter-nix/libtree-sitter-nix.${libExt}")
        val destinationFile = file("src/main/resources/libtree-sitter-nix.${libExt}")

        if (sourceFile.exists()) {
            sourceFile.copyTo(destinationFile, overwrite = true)
            println("Native library copied to resources folder.")
        } else {
            throw GradleException("Native library not found at ${sourceFile.absolutePath} after build.")
        }
    }
}

tasks.clean {
    doLast {
        file("src/main/resources/libtree-sitter.${libExt}").delete()
        file("src/main/resources/libtree-sitter-nix.${libExt}").delete()
    }

    doLast {
        exec {
            workingDir = file("src/main/c/tree-sitter")
            commandLine("make", "clean")
        }
    }

    doLast {
        file("src/main/c/tree-sitter/libtree-sitter.${libExt}").delete()
    }
}

tasks.withType<JavaExec> {
    environment("LD_LIBRARY_PATH", "${project(":tree-sitter-nix").projectDir}/src/main/resources")
}
